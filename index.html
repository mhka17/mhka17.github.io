<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="google-adsense-account" content="ca-pub-7567388531442485">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7567388531442485"
     crossorigin="anonymous"></script>
  <title>Background Trim and Resize</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f0f0f0;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    .preview {
      display: block;
      max-width: 300px;
      max-height: 300px;
      margin: 10px auto;
      border: 1px solid #ccc;
      object-fit: contain;
    }
    .btn {
      display: inline-block;
      padding: 10px 15px;
      margin: 10px 5px 0 0;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background: #0056b3;
    }
    .download-link {
      display: inline-block;
      margin-top: 1rem;
      text-decoration: none;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
    }
    .download-link:hover {
      background: #1e7e34;
    }
    .notice {
      background: #fffae6;
      border-left: 4px solid #ffeb3b;
      padding: 10px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Background Trim and Resize</h1>
    <p>Select an image to remove whitespace, resize to 800×800, and pad to 1000×1000 with a white background.</p>

    <input type="file" id="image-input" accept="image/*" />
    <button class="btn" id="process-btn">Process Image</button>

    <img id="preview" class="preview" alt="Preview will appear here" />
    <a id="download-link" class="download-link" href="#" download="trimmed_resized.jpg" style="display: none;">Download Result</a>

    <div class="notice">
      <strong>Note:</strong> This process is done entirely in your browser via the HTML5 Canvas API, so large images may be slow or consume more memory.
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('image-input');
    const processBtn = document.getElementById('process-btn');
    const previewImg = document.getElementById('preview');
    const downloadLink = document.getElementById('download-link');

    let loadedImage = null;

    // When the user selects a file, load it into an Image object.
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            loadedImage = img;
            previewImg.src = img.src;
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    processBtn.addEventListener('click', () => {
      if (!loadedImage) {
        alert('Please select an image first.');
        return;
      }

      // Step 1: Draw image onto a canvas
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');
      tempCanvas.width = loadedImage.width;
      tempCanvas.height = loadedImage.height;
      ctx.drawImage(loadedImage, 0, 0);

      // Step 2: Get image data and find bounding box of non-white pixels
      const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
      const data = imageData.data;
      let minX = tempCanvas.width;
      let maxX = 0;
      let minY = tempCanvas.height;
      let maxY = 0;

      // We'll treat anything not close to white (say, R,G,B < 250) as content.
      // This is a naive approach but often works for whitespace.
      const threshold = 250;

      for (let y = 0; y < tempCanvas.height; y++) {
        for (let x = 0; x < tempCanvas.width; x++) {
          const index = (y * tempCanvas.width + x) * 4;
          const r = data[index];
          const g = data[index + 1];
          const b = data[index + 2];
          // const a = data[index + 3]; // alpha if needed

          // Check if this pixel is significantly non-white
          if (r < threshold || g < threshold || b < threshold) {
            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;
          }
        }
      }

      // If the image is all white, handle gracefully
      if (minX > maxX || minY > maxY) {
        alert('Image appears to be all white or too close to white. No trimming applied.');
        minX = 0;
        minY = 0;
        maxX = loadedImage.width - 1;
        maxY = loadedImage.height - 1;
      }

      const trimWidth = maxX - minX + 1;
      const trimHeight = maxY - minY + 1;

      // Step 3: Draw the trimmed area onto a new canvas
      const trimmedCanvas = document.createElement('canvas');
      trimmedCanvas.width = trimWidth;
      trimmedCanvas.height = trimHeight;
      const trimmedCtx = trimmedCanvas.getContext('2d');
      trimmedCtx.drawImage(
        tempCanvas,
        minX,
        minY,
        trimWidth,
        trimHeight,
        0,
        0,
        trimWidth,
        trimHeight
      );

      // Step 4: Resize the trimmed image so that the max dimension is 800
      // while preserving aspect ratio.
      const maxSize = 800;
      let finalWidth = trimWidth;
      let finalHeight = trimHeight;
      if (trimWidth > trimHeight) {
        if (trimWidth > maxSize) {
          finalWidth = maxSize;
          finalHeight = Math.round((trimHeight / trimWidth) * maxSize);
        }
      } else {
        if (trimHeight > maxSize) {
          finalHeight = maxSize;
          finalWidth = Math.round((trimWidth / trimHeight) * maxSize);
        }
      }

      const resizedCanvas = document.createElement('canvas');
      resizedCanvas.width = finalWidth;
      resizedCanvas.height = finalHeight;
      const resizedCtx = resizedCanvas.getContext('2d');
      // Draw with smoothing
      resizedCtx.imageSmoothingEnabled = true;
      resizedCtx.imageSmoothingQuality = 'high';
      resizedCtx.drawImage(trimmedCanvas, 0, 0, finalWidth, finalHeight);

      // Step 5: Place the resized image onto a 1000x1000 white canvas, centered.
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = 1000;
      finalCanvas.height = 1000;
      const finalCtx = finalCanvas.getContext('2d');

      // Fill with white
      finalCtx.fillStyle = '#ffffff';
      finalCtx.fillRect(0, 0, 1000, 1000);

      const offsetX = (1000 - finalWidth) / 2;
      const offsetY = (1000 - finalHeight) / 2;

      finalCtx.drawImage(resizedCanvas, offsetX, offsetY);

      // Step 6: Convert to data URL and show preview
      const finalDataURL = finalCanvas.toDataURL('image/jpeg');
      previewImg.src = finalDataURL;

      // Provide a download link
      downloadLink.href = finalDataURL;
      downloadLink.style.display = 'inline-block';
    });
  </script>
</body>
</html>

